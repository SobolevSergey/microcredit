
ОБЗОР КОМПОНЕНТА FiasUpdater

Проект Fias обеспечивает поддержку локальной базы данных адресообразующих элементов (kladr), основанной на данных Федеральной информационной адресной системы (сокращенно ФИАС, http://fias.nalog.ru/Public/DownloadPage.aspx).

Для загрузки и обновления данных из ФИАС служит сеансовый компонент EJB FiasUpdater. Он работает с выгрузками БД ФИАС в формате XML, позволяя обрабатывать как полные выгрузки БД, так и частичные обновления. Необходимость обработки большого объема данных (в случае полного обновления - загрузка и обработка архивного файла размером примерно 3,5 ГБ, добавление свыше 2,5 млн. записей) обусловила следующие технические особенности решения:
  1. Самостоятельное управление транзакциями.
  2. Использование внешней программы для распаковки архива RAR (ВАЖНО!).
  3. Использование SAX-парсера для обработки больших файлов XML.
  
Журналирование операций обновления локальной БД и, одновременно, контроль ее текущего состояния осуществляются с помощью таблицы journal. Сведения о текущем состоянии БД определяются последней записью с непустым значением поля versionid.

ОСНОВНЫЕ МЕТОДЫ

Публичные методы компонента FiasUpdater описаны в интерфейсе FiasUpdaterLocal. Основными методами являются:

  replaceFias() - Скачивает полную актуальную версию БД ФИАС и полностью заменяет записи локальной базы данных.

  replaceFias(String filePath, int versionId, String versionText) - Выполняет полное обновление локальной БД из предварительно скачанного и размещенного на сервере архивного файла.

  updateFias() - Выполняет обновление локальной БД до актуальной версии. При необходимости выполняется полная перезагрузка базы данных.

  updateFias(Integer updateLimit, boolean replaceIfNecessary) - Выполняет обновление локальной БД в соответствии с заданными параметрами. Можно задать количество обрабатываемых за одну операцию обновлений и поведение в случае необходимости полного обновления локальной БД (выполнить полное обновление или поднять исключение).

Предусмотрены методы для просмотра сведений о текущем состоянии локальной БД - дата последнего обновления, номер и краткое текстовое описание текущей версии БД ФИАС, количество доступных обновлений.

ИСКЛЮЧЕНИЯ

Методы компонента FiasUpdater поднимают исключения FiasException, классифицированные кодами. Наиболее важными для разработки пользовательских интерфейсов являются следующие коды:

  FULL_UPDATE_REQUIRED - Требуется полное обновление БД ФИАС (нет сведений о текущей версии локальной БД или локальная БД сильно устарела).
  UPDATE_IN_PROGRESS - Процесс обновления уже запущен. Необходимо подождать завершения процесса или истечения таймаута.

Эти и другие коды описаны в исходном файле класса FiasException.

КОНФИГУРАЦИЯ КОМПОНЕНТА

С помощью соответствующих сеттеров и геттеров (см. интерфейс FiasUpdaterLocal) можно получить и изменить следующие свойства компонента FiasUpdater:

  downloadServiceUrl - URL Веб-сервиса ФИАС, по которому доступна информацию об обновлениях.
  externalUnrarCommand - Внешняя команда для распаковки RAR-архива (без аргументов). Может включать полный путь к исполняемому файлу. Например, "unrar" или "C:/Program Files/7-Zip/7z.exe". Значение по умолчанию - "unrar".

Данные свойства можно также задать с помощью файла ресурсов проекта ejb-jar.xml. Например,

    <session>
      <ejb-name>FiasUpdater</ejb-name>
      <ejb-class>ru.simplgroupp.fias.ejb.FiasUpdater</ejb-class>
      <session-type>Stateless</session-type>
      <business-local>ru.simplgroupp.fias.ejb.FiasUpdaterLocal</business-local>
      ...
      <env-entry>
        <env-entry-name>externalUnrarCommand</env-entry-name>
        <env-entry-type>java.lang.String</env-entry-type>
        <env-entry-value>C:/Program Files/7-Zip/7z.exe</env-entry-value>
      </env-entry>
      ...
    </session>

С помощью файла ejb-jar.xml можно также настроить запуск обновления БД ФИАС по расписанию. В качестве вызываемого метода следует указать "handleTimer". Данный метод запускает updateFias(), что, в зависимости от текущего состояния базы данных, позволяет обновить или полностью перегрузить записи ФИАС. В следующем примере настроено обновление БД ФИАС по понедельникам в полночь:

    <session>
      <ejb-name>FiasUpdater</ejb-name>
      <ejb-class>ru.simplgroupp.fias.ejb.FiasUpdater</ejb-class>
      <session-type>Stateless</session-type>
      <business-local>ru.simplgroupp.fias.ejb.FiasUpdaterLocal</business-local>
      ...
      <timer>
        <schedule>
          <second>0</second>
          <minute>0</minute>
          <hour>0</hour>
          <day-of-week>1</day-of-week>
          <month>*</month>
          <year>*</year>
        </schedule>
        <timeout-method>
          <method-name>handleTimer</method-name>
          <method-params>
            <method-param>javax.ejb.Timer</method-param>
          </method-params>
        </timeout-method>
      </timer>
      ...
    </session>

Выгрузка обновлений для БД ФИАС, согласно http://fias.nalog.ru/Public/DownloadPage.aspx, выполняется примерно раз в неделю, поэтому вполне целесообразно синхронизировать данные, например, 1-2 раза в неделю.